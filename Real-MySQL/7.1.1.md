# 7.1.1 2단계 키 관리

MySQL 서버의 TDE에서 암호화는 키링 플러그인에 의해 관리되며, 8,0에서 지원되는 키링 플러그인은 다음과 같다.

1. keyring_file File-Based 플러그인
2. keyring_encrypted_file Keyring 플러그인
3. keyring_okv KMIP 플러그인
4. keyring_aws Amazon Web Services Keyring 플러그인

위와 같이 다양한 플러그인이 제공되지만, 키를 관리하는 방법만 다를 뿐 서버 내부적으로 작동되는 방식은 모두 동일하다. MySQL 서버의 키링 플러그인은 2단계 키 관리 방식을 사용한다.

마스터키와 테이블스페이스 키라는 두가지 종류의 키를 가지고 있는데, 테이블스페이스 키는 프라이빗 키라고도 불린다. 

플러그인을 사용해서 마스터 키를 가져오고 암호화된 테이블이 생성될 때마다 해당 테이블을 위한 임의의 테입르 스페이스 키를 발급한다.  그리고  MySQL 서버는 마스터 키를 이용해 테이블스페이스키를 암호화해서 각 테이블의 데이터 파일헤더에 저장한다.

테이블스페이스키는 절대 MySQL 외부에 노출되지 않기 때문에 보안상 문제가 되지 않지만 마스터키는 외부의 파일을 이용하기 때문에 노출될 가능성이 있다. 따라서 마스터 키는 주기적으로 변경해야 한다. 다음과 같은 명령어를 주면 변경할 수 있다.

```mysql
> ALTER INSTANCE ROTATE INNODB MASTER KEY;
```

마스터 키를 변경하면 MySQL 서버는 기존의 마스터 키를 이용해 각 테이블의 `테이블스페이스 키`를 복호화한 다음 새로운 마스터 키로 다시 암호화 한다. 이는 데이터 파일에 전혀 영향이 없다.

하지만 테이블스페이스키를 변경된다면 모든 데이터 파일들을 복호화한 다음 새로운 테이블스페이스키로 암호화 해야한다. 이는 과도한 시스템 부하를 주게 되며 사용자 쿼리를 처리하는 데도 상당한 영향을 미치게 된다.

# 리두 로그 및 로그 버퍼

리두 로그는 여러 문제에서 서버가 비정상적으로 종료됐을 때 데이터 파일에 기록되지 못한 데이터를 잃지 않게 해주는 안전장치이다.

대부분의 데이터베이스들은 데이터 변경 내용을 로그에 먼저 기록한다. 모든 DBMS는 쓰기보다 읽기의 성능을 고려한 자료구조를 가지고 있기 때문에 데이터 파일 쓰기는 디스크의 랜덤 액세스가 필요하다. 따라서 데이터를 데이터 파일에 기록하려면 상대적으로 큰 비용이 필요하다.

이러한 이유로 인해 DB는 상대적으로 쓰기 비용이 낮은 리두 로그를 가지고 있으며, 비정상 종료 발생시 리두 로그 내용을 이용해 서버를 복구한다.

스토리 엔진의 데이터 파일은 다음과 같이 두가지 종류의 일관되지 않은 데이터를 가질 수 있다.

1. 커밋됐지만 데이터 파일에 기록되지 않은 데이터 
   * 리두 로그에 저장되어 있는 데이터 파일으르 다시 복사하기만 하면 됌
2. 롤백됐지만 데이터 파일에 이미 기록된 데이터
   * 언두 로그의 내용을 가지고 와서 데이터 파일에 복사
   * 리두 로그가 필요없는 것 처럼 보이지만 최소한 변경된 커밋이나 롤백, 트랜잭션 실행 중간 상태등 리두 로그에서 확인 필요

리두 로그는 트랜잭션이 커밋되면 바로 디스크로 기록되도록 하는 것이 안전하고 좋지만 많은 부하를 일으킨다. 따라서 MySQL은 `innodb_flush_log_at_trx_commit` 시스템 변수를 통해 어느 주기로 디스크에 동기화할지를 제공해준다.

리두 로그 파일들의 전체 크기는 InnoDB 스토리지 엔진이 가지고 있는 버퍼 풀의 효율성을 결정하기 때문에 신중히 결정해야 한다. 시스템 변수 `innodb_log_file_in_group`, `innodb_log_file_size` 2개 곱으로 전체 리두 파일의 크기를 결정한다. 

전체 크기를 신중하게 결정해야 하는 이유는 스토리지 엔진이 적당히 버퍼풀에 모았다가 디스크에 기록하기 때문이다. 즉 전체 크기를 버퍼 풀의 크기에 맞게 조절해야 성능을 향상시킬 수 있다.

하지만 사용량이 매우 많은 DBMS 같은 경우 리두 로그 작업은 큰 문제가 되는데, 이러한 문제를 보완하기위해 최대한 ACID 속성을 보장하는 수준에서 버퍼링 한다. 이 버퍼링에 사용되는 공간을 로그 버퍼라 부른다. (로그 버퍼는 16MB 권장, 큰 데이터가 자주 변경되면 사이즈 업)



## 리두 로그 아카이빙

리두 로그는 쌓인 내용을 계속 추적하면서 새로 추가된 리두 로그 엔트리를 복사하는데 서버의 데이터 유입량이 너무 많아지면 새로 추가되는 리두 로그 내용을 복사하기도 전에 덮어 쓰일 수도 있다. 이렇게 되면 백업 툴이 리두 로그 엔트리를 복사할 수 없어 백업에 실패하게 된다. 이 때문에 8.0부터 제공되는 리두 로그 아카이빙으로 백업 실패를 막을 수 있다.

아카이빙을 사용하려면 `innodb_redo_log_archive_dirs` 변수를 사용해 백업 디렉터리를 설정해야하며 MySQL 유저만 접근할 수 있다

* 아카이빙 설정 방법 명령어

```mysql
-- // /var/log/mysql_redo_archive 디렉토리 생성
> SET GLOBAL innodb_redo_log_archive_dirs = 'backup:/var/log/mysql_redo_archive';
```

* 리두 로그 복사 시작 명령어

```mysql
-- // 첫번째 인자 : 디렉토리 레이블, 두번째 인자 : 서브 디렉토리 이름
> DO innodb_redo_log_archive_start('backup', '2020072');
```

리두 로그 아카이빙은 로그 파일이 로테이션될 때 복사되는 것이 아니라 리두 로그 파일에 엔트리가 추가될 때 함께 기록되는 방식을 사용하고 있다. 즉 크기가 조금씩 늘어난다.

리두 로그 아카이빙 종료는 다음과 같다.

* 리두 로그 아카이빙 종료 명령어

```mysql
> DO innodb_redo_log_archive_stop();
```

파일은 종료되지만 삭제되지 않기 때문에 수동으로 삭제해줘야 한다. 그리고 리두 로그는 세션이 계속 연결되야지만 아카이빙이 실행된다. 만약 연결이 끊키면 아카이빙은 멈추고 아카이빙 파일도 자동 삭제된다. 



## 리두 로그 활성화 및 비활성화

리두 로그의 특성은 다음과 같다.

1. 트랜잭션이 커밋해도 데이터 파일은 즉시 디스크로 동기화 되지 않지만, 리두 로그는 항상 디스크로 기록된다.
2. 이러한 특성으로 비정상적인 트랜잭션 종료시 복구가 가능하다.

이러한 특징 때문에 리두 로그는 항상 활성화 되어 있다. 하지만 8.0부터 리두 로그를 수동으로 비활성화 할 수 있게 되었다. 이렇게 한 이유는 대용량 데이터의 적재 시간을 단축시킬 수 있기 때문이다. 

리두 로그의 활성화 여부는 다음과 같다.

* 리두 로그 활성화 여부 명령어

```mysql
--// 비활성화
> ALTER INSTANCE DISABLE INNODB REDO_LOG;

--// 활성화 여부 확인
> SHOW GLOBAL STATUS LIKE 'Innodb_redo_log_enabled';

--// 활성화
> ALTER INSTANCE ENABLE INNODB REDO_LOG;
```

따라서 대용량 데이터 적재 때문에 리두 로그를 껐다면 다 적재하고 다시 키는 것을 잊지말자. 또한 서버가 비정상적으로 종료되어 데이터가 일부 손실되어도 괜찮다면 리두 로그를 비활성화 하는 것 보다 `innodb_flush_log_at_trx_commit` 시스템 변수를 0 또는 2로 설정해서 사용하는 것을 권장한다.
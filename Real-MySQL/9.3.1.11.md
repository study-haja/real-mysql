# 퍼스트 매치

First Match 최적화 전략은 IN 형태의 세미 조인을 EXIST 형태로 튜닝한 것과 비슷한 방법으로 실행된다. 다음 예를 보자.

```mysql
> EXPLAIN SELECT *
  FROM employees e WHERE e.first_name='matt'
    AND e.emp_no IN (
    	SELECT t.emp_no FROM titles t
    	WHERE t.from_date BETWEEN '1995-01-01' AND '1995-01-31'
    	);

---------------------------------------------------------------------------------------------------------
| id | select_type | table | type    | key          | key_len | Extra                                   |
---------------------------------------------------------------------------------------------------------
| 1  | SIMPLE      | de    | ref     | ix_fristname | 233     | Using index                             |
---------------------------------------------------------------------------------------------------------
| 1  | SIMPLE      | e     | ref     | PRIMARY      | 1       | Using where; Using index; FirstMatch(e) |
---------------------------------------------------------------------------------------------------------
```

여기에도 id가 1로 되어있다. 또한 특이사항으로 Extra 컬럼에 FirstMatch라는 문구가 써져있다. 즉 서브쿼리가 아닌 조인으로 처리되었으며, FirstMatch는 레코드를 한건만 찾으면 더이상 titles 테이블 검색을 하지 않는다는 것이다. 

FirstMatch는 서브쿼리가 아닌 조인으로 풀어서 실행하면서 일치하는 첫번째 레코드만 검색하는 최적화를 실행한다. FirstMatch는 다음과 같은 장점이 있다.

> 1. 여러 테이블이 조인되는 경우 원래 쿼리에는 없던 동등 조건을 옵티마이저가 자동으로 추가하는 형태의 최적화가 실행되기도 한다. 기존의 IN-to-EXISTS 최적화에서는 이러한 동등 조건 전파가 서브쿼리 내에서만 가능했지만 FirstMatch에서는 조인 형태로 처리되기 때문에 서브쿼리뿐만 아니라 아우터 쿼리의 테이블까지 전파 될 수 있는 장점이 있다. (실행계획이 좋아진다)
> 2. IN-to-EXISTS 변환 최적화 전략에서는 아무런 조건 없이 변환이 가능한 경우에는 무조건 그 최적화를 수행했다. 하지만 FirstMatch 전략은 서브쿼리의 모든 테이블에 대해 FirstMatch 최적화를 할지 안할지 일부 테이블에서만 선택할수 있다는 장점이 있다.

FirstMatch 최적화는 optimazer_switch 시스템 변수에서 semijoin옵션과 firstmatch 옵션이 모두 ON인 경우에만 사용할 수 있다. 다음은 FirstMatch의 제한 사항이다.

> 1. FirstMatch는 서브 쿼리에서 하나의 레코드만 검색되면 더이상의 검색을 멈추는 단축 실행 경로이기 때문에 FirstMatch 최적화에서 서브쿼리는 그 서브쿼리가 참조하는 모든 아우터 테이블이 먼저 조회된 이후에 실행된다.
> 2. FirstMatch 최적화가 사용되면 실행 계획은 Extra 컬럼에 FirstMatch 문구가 뜬다
> 3. FirstMatch 최적화는 상관 서브 쿼리에서도 사용될 수 있다.
> 4. FirstMatch 최적화는 GROUP BY나 집합 함수가 사용된 서브쿼리의 최적화에는 사용될 수 없다.
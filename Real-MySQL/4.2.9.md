# 언두 로그

InnoDB 스토리지 엔진은 트랜잭션과 격리 수준을 보장하기 위해 DML로 변경되기 이전 버전의 데이터를 백업해 놓는다. 이렇게 백업해 놓은 데이터를 `언두 로그`라고 부른다.

언두 로그의 사용은 다음과 같다.

1. 트랜잭션 보장
   * 트랜잭션이 롤백되면 트랜잭션 도중 변경된 데이터를 변경 전 데이터로 복구할 때 사용
2. 격리 수준 보장
   * 특정 커넥션에서 데이터를 변경하던 도중에 다른 커넥션에서 데이터를 조회하면 격리 수준에 맞게 레코드를 읽을 때 사용



## 언두 로그 레코드 모니터링

* 업데이트 예제

```mysql
> UPDATE member SET namme='홍길동' WHERE  member_id=1;
```

위 예제에서 커밋하지 않아도 실제 데이터 파일은 홍길동으로 변경된다. 그리고 변경되기 전에 값이 벽계수였다면 언두 영역에서는 벽계수라는 값이 백업되는 것이다. 

이 상태에서 사용자가 커밋하면 현재 상태가 그대로 유지되고, 롤백하면 언두 영역의 백업된 데이터를 다시 데이터 파일로 복구한다.

언두 로그의 데이터는 크게 2가지 영역에서 사용된다.

1. 트랜잭션 롤백 대비용
2. 트랜잭션의 격리 수준을 유지하면서 높은 동시성을 제공

MySQL 5.5 이전 버전에서는 한번 증가한 언두 로그 공간은 다시 줄어들지 않았다. 또한 트랜잭션이 완료됐다고 해서 언두 로그를 바로 삭제할 수 있는건 아니다. 그렇기 때문에 대용량 데이터 처리하는 트랜잭션에서 언두의 크기가 엄청나게 커질 수 있다.

하지만 5.7, 8.0 버전에서 부터는 언두. 로그 공간의 문제점은 완전히 해결됐다. MySQL 8.0에서는 언두 로그를 돌아가면서 순차적으로 사용해 디스크 공간을 줄이는 것도 가능하며, 때로는 서버가 필요한 시점에 사용공간을 줄여 주기도 한다.

하지만 여전히 활성 상태의 트랜잭션을 장시간 동안 유지하는 것은 안좋다. 따라서 사용자는 항상 언두 로그를 모니터링 하는 것이 좋다.

* 언두 로그를 모니터링 하는 명령어

```mysql
--// mysql 모든 버전 사용 가능
> SHOW ENGINE INNODB STATUS \G

--// mysql 8.0 에서만 사용 가능
> SELECT count
	FROM information_schema.innodb_metrics
	WHERE SUBSYSTEM='transaction' AND NAME = 'trx_rseg_history_len';
```



## 언두 테이블스페이스 관리

언두 로그가 저장되는 공간을 언두 스페이스라 부른다. 언두 스페이스는 다음과 같이 변화를 거쳤다.

1. MySQL 5.6 버전에서 모두 시스템 테이블스페이스에 저장 (ibdata.ibd) - 확장의 한계
2. 5.6, 5.7 버전은 innodb_undo_tablespaces 시스템 변수를 활용해 별도의 언두 로그 파일을 사용 - 0 이면 시스템 테이블스페이스에 저장
3. 8.0 버전은 위 시스템 변수가 사라지고 항상 별도의 로그 파일로 기록

언두 테이블스페이스는 1~128개의 롤백 세그먼트를 가지며 하나의 세그먼트는 1개 이상의 언두 슬롯을 가진다.

따라서 하나의 롤백 세그먼트는 InnoDB의 페이지 크기를 16바이트로 나눈 값의 개수만큼의 언두 슬롯을 가진다. 즉 최대 동시 트랜잭션 수의 수식은 다음과 같다.

> 최대 동시 트랜잭션 수 = (InnoDB 페이지 크기) / 16 * (롤백 세그먼트 개수) * (언두 테이블스페이스 개수)

위 크기의 최대는 일반 서비스에서 사용할 일이 없기 때문에 트랜잭션을 기본값으로 유지하면 된다.

언두 로그는 공간이 남는건 상관 없지만 로그 슬롯이 부족하면 트랜잭션을 시작할 수 없는 심각한 문제를 낳는다. 그리고. 8.0부터는 TABLESPACE를 생성하거나 삭제할 수 있게 개선됐다.

언두 테이블스페이스 공간을 필요한 만큼만 남기고 불필요하거나 과도하게 할당된 공간을 운영체제로 반납하는 것을 Undo tablespace truncate라고 부른다. 이는 두가지 방법이 있다.

1. 자동모드

   * 트랜잭션 커밋하면 언두 로그는 불필요
   * 따라서 주기적으로 쓰레드를 활용해 언두 로그 삭제

2. 수동모드

   * 테이블 스페이스를 비활성화해서 불필요한 공간을 잘라내고 운영체제로 해당 공간을 반납

   * 반납하면 다시 언두 테이블 스페이스를 활성화

   * 수동모드는 언두 테이블스페이스가 최소 3개이상일때 작동

     ```mysql
     -- //  언두 테이블스페이스 비활성화
     > ALTER UNDO TABLESPACE tablespace_name SET INACTUVE;
     -- //  언두 테이블스페이스 활성화
     > ALTER UNDO TABLESPACE tablespace_name SET ACTIVE;
     ```

     
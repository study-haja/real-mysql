## 5.2 MySQL 엔진의 잠금

MySQL에서 사용되는 잠금은 **스토리지 엔진 레벨** 과 **MySQL 엔진레벨** 로 나눌수 있다. MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치지만, 스토리지 엔진 레벨의 잠금은 스토리지 엔진 간 상호 영향을 미치지는 않는다.

### 5.2.1 글로벌 락

글로벌 락(GLOBAL LOCK)은 `FLUSH TABLES WITH READ LOCK` 명령으로 획득할 수 있으며, MySQL에서 제공하는 잠금가운데 가장 범위가 넓다. 한 세션에서 글로벌 락을 획득하면 다른 세션에서 SELECT를 제외한 대부분의 DDL 문장이나 DML 문장을 실행하는 경우 글로벌 락이 해제될 때까지 해당 문장이 대기 상태로 남는다. 글로벌 락이 영향을 미치는 범위는 MySQL 서버 전체이며, 작업 대상 테이블이나 데이터 베이스가 다르더라도 동일하게 영향을 미친다. MyISAM이나 MEMORY 테이블에 대한 `mysqldump` 로 일관된 백업을 받아야 할 때는 글로벌 락을 사용해야 한다.

> `FLUSH TABLES WITH READ LOCK` 명령은 테이블에 읽기 잠금을 걸기 전에 먼저 테이블을 플러시해야 하기 때문에 테이블에 실행 중인 모든 종류의 쿼리가 완료돼야 한다. 그래서 장기간 SELECT 쿼리가 실행되고 있을 때는 `FLUSH TABLES WITH READ LOCK` 명령은 `SELECT`쿼리가 종료될 때까지 기다려야 한다.
>
> 글로벌 락은 MySQL 서버의 모든 테이블에 큰 영향을 미치기 때문에 웹 서비스용으로 사용되는 MySQL 서버에서는 가급적 사용하지 않는 것이 좋다.

InnoDB 스토리지 엔진은 트랜젝션을 지원하기 때문에 일관된 데이터 상태를 위해 모든 데이터 변경 작업을 멈출 필요는 없다. 또한 MySQL 8.0 버전부터는 `Xtrabackup` 이나 `Enterprise Backup`과 같은 백업 툴들의 안정적인 실행을 위해 백업 락이 도입됐다. 

특정 세션에서 백업락을 획득하면 모든 세션에서 다음 작업을 수행할 수 없게 된다.

- 데이터베이스 및 테이블 등 모든 객체 생성 및 변경,삭제
- `REPAIR TABLE` 과 `OPTIMIZE TABLE`명령
- 사용자 관리 및 비밀번호 변경

백업락은 일반적인 테이블의 데이터 변경은 허용된다. 백업도중 DDL 명령 하나로 인해 백업이 실패하면 다시 그만큼 시간을 들여서 백업을 다시해야한다. 이러한 문제를 막기 위해 DDL 명령이 실행되면 복제를 일시 중지한다.
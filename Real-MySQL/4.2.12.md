# 어댑티브 해시 인덱스

어댑티브 해시 인덱스는 InnoDB 스토리지 엔진에서 사용자가 자주 요청하는 데이터에 대해 자동으로 생성하는 인덱스를 말한다. 이 인덱스는 `innodb_adaptive_hash_index` 시스템 변수를 사용해 활성화, 비활성화를 할 수 있다.

우리가 잘 알고 있는 B-Tree 인덱스는 빠르다고 많은 사람들이 생각할 수 있지만 상황에 따라 다르다. 예를 들어 B-Tree 인덱스를 동시에 몇천 개의 쓰레드에서 실행하면 당연히 쿼리의 성능이 떨어질 것이다.

따라서 어댑티브 해시 인덱스는 위와 같은 B-Tree의 검색 시간을 줄여주고자 도입된 기능이다. 어댑티브 해시 인덱스의 플로우는 다음과 같다.

1. InnoDB 스토리지 엔진은 자주 읽히는 데이터 페이지의 키 값을 이용해 해시 인덱스를 생성
2. 필요할 때 마다 어댑티브 해시 인덱스를 검색
3. 레코드를 즉시 서칭

즉 위와 같은 방법으로 B-Tree의 루트 노드부터 리프노드까지 찾아가는 비용을 없앨 수 있고 그만큼 컴퓨터는 더 많은 쿼리를 동시에 처리 할 수 있다.

해시 인덱스는 다음과 같이 관리된다.

> 인덱스 키 값 : 데이터 페이지 주소
>
> -> B-Tree 인덱스의 고유 번호 : B-Tree 인덱스의 실제 키 값

인덱스의 고유 번호는 B-Tree 인덱스에 대한 어댑티브 해시 인덱스가 하나의 해시 인덱스에 저장되기 때문에 구분이 가능하다. 그리고 데이터 페이지 주소 같은 경우 실제 키 값이 저장된 데이터 페이지의 메모리 주소 즉 InnoDB 버퍼 풀에 로딩된 페이지의 주소를 의미한다. 

따라서 어댑티브 해시 인덱스는 버퍼 풀에 올려진 데이터 페이지에 대해서만 관리하고 해당 데이터 페이지가 없어지면 정보도 사라진다.

![MySQL InnoDB의 Adaptive Hash Index 활용 – tech.kakao.com](http://tech.kakao.com/files/mysql-adaptive-hash-search.png)

위 그림을 보면 어댑티브 해시 인덱스를 사용하지 않았을 경우 처음 초당 6만까지 처리하다 나중에 2만에 가까워지는 것을 볼 수 있다. 하지만 해시 인덱스를 사용하면 나중에 초당 8만 까지 처리하는 것을 볼 수 있다.

이는 B-Tree의 사용이 줄어들면서 InnoDB 내부 잠금(세마포어) 횟수가 획기적으로 줄어드는 것을 불 수 있다.

그리고 파티션을 이용해 어댑티브 해시 인덱스의 내부 잠금 경합을 줄일 수 있다. 기본값은 8이며 `innodb_adaptive_hash_index_parts` 시스템 변수를 사용해 정할 수 있다.

어떻게 보면 어댑터 해시 인덱스는 만능인것 같지만 다음과 같은 경우 비활성화 시키는 경우도 많다.

1. 디스크 읽기가 많은 경우
2. 특정 패턴의 쿼리가 많은 경우 (조인이나 LIKE 검색)
3. 매우 큰 데이터를 가진 테이블의 레코드를 폭넓게 읽는 경우

다음과 같은 경우는 성능 향상에 도움이 된다.

1. 디스크의 데이터가 InnoDB 버퍼 풀 크기와. 비슷한 경우 (디스크 읽기가 많지 않은 경우)
2. 동등 조건 검색(동등 비교와 IN 연산자)이 많은 경우
3. 쿼리가 데ㅔ이터 중에서 일부 데이터에만 집중되는 경우

이렇게 보면 판단하기 어렵겠지만, 데이터 페이지를 디스크에서 읽어오는 경우가 빈번한 경우라면 아무런 도움이 되지 않는다. 또한 비용도 공짜가 아니고 활성화 시켜놓으면 매번 인덱스 키 값을 찾기 때문에 해시 인덱스의 효율이 없는 경우라면 사용하지 않는 것이 좋다.

그리고 해시 인덱스는 삭제나 변경(ALTER) 작업에도 많은 영향을 미친다. 그 이유는 모든 데이터 페이지들을 해시 인덱스에서 삭제하거나 변경해야 하기 때문이다. 즉 테이블이 삭제되거나 스키마가 변경되면 많은 CPU 자원을 사용하고, 그만큼 성능이 느려진다.

해시 인덱스가 필요한지 판단해야 한다면 서버의 상태 값을 보면 된다. 해시 인덱스는 기본적으로 활성화 되어 있다.

* 서버의 상태를 보는 명령어

```mysql
> SHOW ENGINE INNODB STATUS\G

....

// 1.03번 해시 인덱스를 사용, 2.64번 해시 인덱스를 사용하지 못함
// 해시 인덱스를 사용하지 않으면 hash searhes/s 값은 0으로 표시
// 해시 인덱스가 사용하는 메모리 공간, 서버의 CPU 사용량을 종합적으로 판단

1.03 hash searhes/s, 2.64 non-hash searches/s 
...
```

여기서 searhes는 쿼리 실행 횟수가 아니라 쿼리가 처리되기 위해 내부적으로 키 갑스이. 검색이 몇번 실행됐느냐를 의미한다.

어댑티브 해시 인덱스의 메모리 사용량은 다음과 같다.

* 어댑티브 해시 인덱스 메모리 사용량을 확인하는 명령어

```mysql
> SELECT EVENT_NAME, CURRENT_NUMBER_OF_BYTES_USED
	FROM performance_schema.memory_summary_global_by_event_name
	WHERE EVENT_NAME = 'memory/innodb/adaptive hash index';
```
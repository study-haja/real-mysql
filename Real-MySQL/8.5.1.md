# 인덱스 알고리즘

전문 검색에서는 문서 내용에서 사용자가 검색하게 될 키워드를 분석해 내고, 빠른 검색용으로 사용할 수 있게 이러한 키워드로 인덱스를 구축한다.

일반적으로 전문검색은 키워드를 인덱싱하는 기법에 따라 크게 단어의 어근 분석과 n-gram 분석 알고리즘으로 구분할 수 있다.



## 어근 분석 알고리즘

전문검색 인덱스는 다음과 같은 두가지 중요한 과정을 거쳐 색인 작업이 수행된다.

* 불용어 처리 : 검색에서 별 가치가 없는 단어를 모두 필터링해서 제거하는 작업
* 어근 분석 : 검색어로 선정된 단어의 뿌리인 원형을 찾는 작업

불용어 처리 같은 경우 개수가 많지 않아 상수로 정의해서 처리하는 경우가 많고 유연성을 위해 불용어 자체를 데이터베이스화해 사용자가 추가/삭제 할수 있게 구현하는 경우도 있다.

어근 분석은 오픈소스인 MeCab 플러그인을 사용해 작업을 할 수 있다. 사실 한글이나 일본어는 어근 분석보다 형태소를 분석해서 명사와 조사를 구분하는 것이 더 중요한 편이어서 서구권들은 mongodb의 snowball이라는 오픈소스를 더 많이 사용하지만 한글 같은 경우 위 플러그인으로도 충분하다.

MeCab을 제대로 작동시키기 위해서는 단어사전이 필요하며 문장을 해체해서 각 단어의 품사와 식별할 수 있는 문장의 구조 인식이 필요하고 언어를 학습하는 과정이 필요하다. 이는 상당한 시간이 필요하기 때문에 한글에 맞게 완성도를 높이기 위해서는 많은 시간과 노력이 필요하다.



## n-gram 알고리즘

어근 분석은 많은 시간과 노력이 필요하기 때문에 보통 n-gram 알고리즘을 많이 사용한다. 

n-gram은 보통 키워드를 검색하기 위해 사용하는 알고리즘으로 **본문을 무조건 몇 글자씩 잘라서 인덱싱하는 방법이다.** n-gram의 장단점은 다음과 같다.

1. 장점
   1. 어떤 나라의 언어든 이해와 준비작업이 필요 없음
2. 단점
   1. 만들어진 인덱스의 크기가 상당히 큰 편

n-gram의 n은 인덱싱할 키워드의 최소 글자 수를 의미하는데, 일반적으로 2글자 이다. 다음 예를 보자

```
To be or not to be. That is the question
```

위 글을 n-gram으로 쪼개면 다음과 같다.

| 단어     | 토큰 | 토큰 | 토큰 | 토큰 | 토큰 | 토큰 | 토큰 |
| -------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| To       | To   |      |      |      |      |      |      |
| be       | be   |      |      |      |      |      |      |
| or       | or   |      |      |      |      |      |      |
| not      | no   | ot   |      |      |      |      |      |
| to       | to   |      |      |      |      |      |      |
| be       | be   |      |      |      |      |      |      |
| That     | Th   | ha   | at   |      |      |      |      |
| is       | is   |      |      |      |      |      |      |
| the      | th   | he   |      |      |      |      |      |
| question | qu   | ue   | es   | st   | ti   | io   | on   |

띄어쓰기와 마침표를 기준으로 10개 단어로 split을 했다. 그리고 앞뒤로 2글자씩 중첩해서 토큰으로 분리했다. 만약 10글자 단어라면 그 단어는 10-1개 즉 9개의 토큰으로 인덱스에 저장한다. 그리고 이때 중복된 토큰은 하나의 인덱스 엔트리로 병합되어 저장된다.

MySQL은 이렇게 생성된 토큰들에 대해 불용어를 걸러내는 작업을 수행하는데, 이때 불용어와 동일하거나 불용어를 포함하는 경우 걸러서 버린다. 불용어를 확인하고 싶으면 다음과 같은 명령어를 치면 된다.

```mysql
> SELECT * FROM information_schema.INNODB_FT_DEFAULT_STOPWORD;

| value |
---------
| a     |
| about |
| an    |
...
```

다음은 위 토큰을 실제 인덱스로 저장되는 엔트리는 다음과 같다.

| 입력 | 불용어 일치 | 불용어 포함 | 출력(최종 인덱스 등록) |
| ---- | ----------- | ----------- | ---------------------- |
| at   |             | O           |                        |
| be   | O           |             |                        |
| be   | O           |             |                        |
| es   |             |             | es                     |
| ha   |             | O           |                        |
| he   |             |             | he                     |
| io   |             | O           |                        |
| is   |             | O           | no                     |
| no   |             |             |                        |
| on   | O           |             |                        |
| or   | O           |             |                        |
| ot   |             |             | ot                     |
| qu   |             |             | qu                     |
| st   |             |             | st                     |
| Th   |             |             | Th                     |
| th   |             |             | th                     |
| ti   |             | O           |                        |
| To   | O           |             |                        |
| to   | O           |             |                        |
| ue   |             |             | ue                     |

이렇게 출력 (최종 인덱스 등록) 컬럼에만 표신된 것들만 전문 검색 인덱스에 등록한다.

물론 전문 검색을 빠르게 하기 위해 2단계 인덱싱과 같은 방법도 있지만 MySQL 서버는 이렇게 구분된 코튼을 단순한 B-Tree 인덱스에 저장한다. 성능 향상을 위해 Merge-Tree 같은 기능을 가지고 있긴 하지만 n-gram은 이 정도만 알면 된다.



## 불용어 변경 및 삭제

위에서 불용어가 포함됐다고 등록이 안된 토큰들이 있다. 이는 사실 사용자 입장에서 더 혼란스럽기 때문에 MySQL의 불용어 처리를 완전히 무시하거나 내장된 불용어 대신 사용자가 직접 불용어를 등록하는 방법을 권장한다.

### 전문 검색 인덱스의 불용어 처리 무시

불용어 처리를 무시하는 방법은 두가지가 있다.

1. 스토리지 엔진에 관계 없이 MySQL 서버의 모든 전문 검색 인덱스에 대해 불용어를 완전히 제거하는 방법
   1. my.cnf의 ft_stopword_file 시스템 변수를 빈 문자열로 설정 -> 서버를 재시작해야 함
   2. 해당 시스템 변수는 사용자 정의 불용어를 적용할 때도 사용 (파일 경로로 저장)
2. 스토리지 엔진을 사용하는 테이블의 전문 검색 인덱스에 대해서만 불용어 처리를 무시하게 하는 방법
   1. innodb_fe_enable_stopword 시스템 변수를 OFF로 설정 -> 동적이라 서버를 재시작 할 필요가 없음
   2. 이러면 다른 스토리지 엔진을 사용하는 테이블은 내장 불용어를 사용함

### 사용자 정의 불용어 사용

사용자 정의 불용어 사용법은 두가지 방법이 있다.

1. 불용어 목록을 파일로 저장 -> 서버 설정 파일에 경로 저장
   * ft_stopword_file = '/data/my_custom_stopword.txt'
2. 불용어의 목록을 테이블로 저장하는 방식
   * InnoDB 스토리지 엔진을 사용한 테이블에서만 사용가능
   * innodb_ft_server_stopword_table 시스템 변수에 불용어 테이블을 설정 (innodb_ft_user_stopword_table 시스템 변수도 사용 가능)
   * 불용어 목록을 변경한 이후 전문 검색 인덱스가 생성 되야만 변경된 불용어가 적용됌

```mysql
> CREATE TABLE my_stopword(value VARCHAR(30)) ENGINE = INNODB;
> INSERT INTO my_stopword(value) VALUES ('MySQL');

> SET GLOBAL innodb_ft_server_stopword_table='mydb/my_stopword';
> ALTER TABLE tb_bi_gram
	ADD FULLTEXT INDEX fx_title_body(title, body) WITH PARSER ngram;
```





